- name: Ingress-nginx. Add helm repo.
  community.kubernetes.helm_repository:
    name: ingress-nginx
    repo_url: "https://kubernetes.github.io/ingress-nginx"
  tags:
    - upgrade_cluster_components

- name: Ingress-nginx. Deploy ingress-nginx.
  community.kubernetes.helm:
    name: ingress-nginx
    chart_ref: ingress-nginx/ingress-nginx
    namespace: ingress-nginx
    create_namespace: yes
    update_repo_cache: yes
    values:
      hostNetwork: true
      hostPort:
        enabled: true
      kind: DaemonSet
      toleration:
        - key: "node-role.kubernetes.io/master"
          operator: "Exist"
          effect: "NoSchedule"
      controller:
        metrics:
          enabled: true
          serviceMonitor:
            namespace: prometheus
            enabled: true
            additionalLabels:
              release: prometheus
  tags:
    - upgrade_cluster_components
